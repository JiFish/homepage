(function(){"use strict";async function saveWasmStateToIndexedDB(e){const r=new Uint32Array(e),n=await new Promise((s,t)=>{const o=indexedDB.open("TamaDB",1);o.onupgradeneeded=()=>{o.result.createObjectStore("states",{keyPath:"id"})},o.onsuccess=()=>{s(o.result)},o.onerror=a=>{console.error("DB save error on open",a),t(o.error??new Error("Unknown DB error"))}});await new Promise((s,t)=>{const i=n.transaction(["states"],"readwrite").objectStore("states").put({id:"tamaState",buffer:r});i.onsuccess=()=>{s(void 0)},i.onerror=u=>{console.error("DB save error on write",u),t(i.error??new Error("Unknown DB error"))}}),n.close()}async function readWasmStateFromIndexedDB(){const e=await new Promise((n,s)=>{const t=indexedDB.open("TamaDB",1);t.onupgradeneeded=()=>{t.result.createObjectStore("states",{keyPath:"id"})},t.onsuccess=()=>{n(t.result)},t.onerror=()=>{s(t.error??new Error("Unknown DB error"))}}),r=await new Promise((n,s)=>{const a=e.transaction(["states"],"readonly").objectStore("states").get("tamaState");a.onsuccess=()=>{const i=a.result;i!=null&&i.buffer instanceof Uint32Array&&n(i.buffer)},a.onerror=()=>{s(a.error??new Error("Unknown DB error"))}});return e.close(),r}var TamaModule=(()=>{var _scriptName=self.location.href;return async function(moduleArg={}){var moduleRtn,Module=moduleArg,readyPromiseResolve,readyPromiseReject,readyPromise=new Promise((e,r)=>{readyPromiseResolve=e,readyPromiseReject=r}),ENVIRONMENT_IS_WEB=typeof window=="object",ENVIRONMENT_IS_WORKER=typeof WorkerGlobalScope<"u",ENVIRONMENT_IS_NODE=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer";if(ENVIRONMENT_IS_NODE){const{createRequire:e}=await Promise.resolve().then(function(){return __viteBrowserExternal});var require=e(self.location.href)}var moduleOverrides={...Module},scriptDirectory="";function locateFile(e){return Module.locateFile?Module.locateFile(e,scriptDirectory):scriptDirectory+e}var readAsync,readBinary;if(ENVIRONMENT_IS_NODE){var fs=require("fs"),nodePath=require("path");self.location.href.startsWith("data:")||(scriptDirectory=nodePath.dirname(require("url").fileURLToPath(self.location.href))+"/"),readBinary=e=>{e=isFileURI(e)?new URL(e):e;var r=fs.readFileSync(e);return r},readAsync=async(e,r=!0)=>{e=isFileURI(e)?new URL(e):e;var n=fs.readFileSync(e,r?void 0:"utf8");return n},!Module.thisProgram&&process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2)}else(ENVIRONMENT_IS_WEB||ENVIRONMENT_IS_WORKER)&&(ENVIRONMENT_IS_WORKER?scriptDirectory=self.location.href:typeof document<"u"&&document.currentScript&&(scriptDirectory=document.currentScript.src),_scriptName&&(scriptDirectory=_scriptName),scriptDirectory.startsWith("blob:")?scriptDirectory="":scriptDirectory=scriptDirectory.slice(0,scriptDirectory.replace(/[?#].*/,"").lastIndexOf("/")+1),ENVIRONMENT_IS_WORKER&&(readBinary=e=>{var r=new XMLHttpRequest;return r.open("GET",e,!1),r.responseType="arraybuffer",r.send(null),new Uint8Array(r.response)}),readAsync=async e=>{if(isFileURI(e))return new Promise((n,s)=>{var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=()=>{if(t.status==200||t.status==0&&t.response){n(t.response);return}s(t.status)},t.onerror=s,t.send(null)});var r=await fetch(e,{credentials:"same-origin"});if(r.ok)return r.arrayBuffer();throw new Error(r.status+" : "+r.url)});var out=Module.print||console.log.bind(console),err=Module.printErr||console.error.bind(console);Object.assign(Module,moduleOverrides),moduleOverrides=null,Module.arguments&&Module.arguments,Module.thisProgram&&Module.thisProgram;var wasmBinary=Module.wasmBinary,wasmMemory,ABORT=!1,HEAPU8,HEAPU32,isFileURI=e=>e.startsWith("file://");function updateMemoryViews(){var e=wasmMemory.buffer;Module.HEAP8=new Int8Array(e),Module.HEAP16=new Int16Array(e),Module.HEAPU8=HEAPU8=new Uint8Array(e),Module.HEAPU16=new Uint16Array(e),Module.HEAP32=new Int32Array(e),Module.HEAPU32=HEAPU32=new Uint32Array(e),Module.HEAPF32=new Float32Array(e),Module.HEAPF64=new Float64Array(e),Module.HEAP64=new BigInt64Array(e),Module.HEAPU64=new BigUint64Array(e)}function preRun(){if(Module.preRun)for(typeof Module.preRun=="function"&&(Module.preRun=[Module.preRun]);Module.preRun.length;)addOnPreRun(Module.preRun.shift());callRuntimeCallbacks(onPreRuns)}function initRuntime(){wasmExports.f()}function postRun(){if(Module.postRun)for(typeof Module.postRun=="function"&&(Module.postRun=[Module.postRun]);Module.postRun.length;)addOnPostRun(Module.postRun.shift());callRuntimeCallbacks(onPostRuns)}var runDependencies=0,dependenciesFulfilled=null;function addRunDependency(e){var r;runDependencies++,(r=Module.monitorRunDependencies)==null||r.call(Module,runDependencies)}function removeRunDependency(e){var n;if(runDependencies--,(n=Module.monitorRunDependencies)==null||n.call(Module,runDependencies),runDependencies==0&&dependenciesFulfilled){var r=dependenciesFulfilled;dependenciesFulfilled=null,r()}}function abort(e){var n;(n=Module.onAbort)==null||n.call(Module,e),e="Aborted("+e+")",err(e),ABORT=!0,e+=". Build with -sASSERTIONS for more info.";var r=new WebAssembly.RuntimeError(e);throw readyPromiseReject(r),r}var wasmBinaryFile;function findWasmBinary(){return Module.locateFile?locateFile("tama.wasm"):new URL("/assets/tama-DF-eiepa.wasm",self.location.href).href}function getBinarySync(e){if(e==wasmBinaryFile&&wasmBinary)return new Uint8Array(wasmBinary);if(readBinary)return readBinary(e);throw"both async and sync fetching of the wasm failed"}async function getWasmBinary(e){if(!wasmBinary)try{var r=await readAsync(e);return new Uint8Array(r)}catch{}return getBinarySync(e)}async function instantiateArrayBuffer(e,r){try{var n=await getWasmBinary(e),s=await WebAssembly.instantiate(n,r);return s}catch(t){err(`failed to asynchronously prepare wasm: ${t}`),abort(t)}}async function instantiateAsync(e,r,n){if(!e&&typeof WebAssembly.instantiateStreaming=="function"&&!isFileURI(r)&&!ENVIRONMENT_IS_NODE)try{var s=fetch(r,{credentials:"same-origin"}),t=await WebAssembly.instantiateStreaming(s,n);return t}catch(o){err(`wasm streaming compile failed: ${o}`),err("falling back to ArrayBuffer instantiation")}return instantiateArrayBuffer(r,n)}function getWasmImports(){return{a:wasmImports}}async function createWasm(){function e(o,a){return wasmExports=o.exports,wasmMemory=wasmExports.e,updateMemoryViews(),removeRunDependency(),wasmExports}addRunDependency();function r(o){return e(o.instance)}var n=getWasmImports();if(Module.instantiateWasm)return new Promise((o,a)=>{Module.instantiateWasm(n,(i,u)=>{e(i),o(i.exports)})});wasmBinaryFile??(wasmBinaryFile=findWasmBinary());try{var s=await instantiateAsync(wasmBinary,wasmBinaryFile,n),t=r(s);return t}catch(o){return readyPromiseReject(o),Promise.reject(o)}}var callRuntimeCallbacks=e=>{for(;e.length>0;)e.shift()(Module)},onPostRuns=[],addOnPostRun=e=>onPostRuns.unshift(e),onPreRuns=[],addOnPreRun=e=>onPreRuns.unshift(e);Module.noExitRuntime;var _emscripten_date_now=()=>Date.now(),abortOnCannotGrowMemory=e=>{abort("OOM")},_emscripten_resize_heap=e=>{HEAPU8.length,abortOnCannotGrowMemory()},UTF8Decoder=typeof TextDecoder<"u"?new TextDecoder:void 0,UTF8ArrayToString=(e,r=0,n=NaN)=>{for(var s=r+n,t=r;e[t]&&!(t>=s);)++t;if(t-r>16&&e.buffer&&UTF8Decoder)return UTF8Decoder.decode(e.subarray(r,t));for(var o="";r<t;){var a=e[r++];if(!(a&128)){o+=String.fromCharCode(a);continue}var i=e[r++]&63;if((a&224)==192){o+=String.fromCharCode((a&31)<<6|i);continue}var u=e[r++]&63;if((a&240)==224?a=(a&15)<<12|i<<6|u:a=(a&7)<<18|i<<12|u<<6|e[r++]&63,a<65536)o+=String.fromCharCode(a);else{var l=a-65536;o+=String.fromCharCode(55296|l>>10,56320|l&1023)}}return o},UTF8ToString=(e,r)=>e?UTF8ArrayToString(HEAPU8,e,r):"",_emscripten_run_script=ptr=>{eval(UTF8ToString(ptr))},printCharBuffers=[null,[],[]],printChar=(e,r)=>{var n=printCharBuffers[e];r===0||r===10?((e===1?out:err)(UTF8ArrayToString(n)),n.length=0):n.push(r)},_fd_write=(e,r,n,s)=>{for(var t=0,o=0;o<n;o++){var a=HEAPU32[r>>2],i=HEAPU32[r+4>>2];r+=8;for(var u=0;u<i;u++)printChar(e,HEAPU8[a+u]);t+=i}return HEAPU32[s>>2]=t,0},wasmImports={d:_emscripten_date_now,c:_emscripten_resize_heap,a:_emscripten_run_script,b:_fd_write},wasmExports=await createWasm();wasmExports.f,Module._tama_wasm_init=wasmExports.g,Module._tama_wasm_step=wasmExports.h,Module._tama_wasm_button=wasmExports.j,Module._tama_wasm_save=wasmExports.k,Module._malloc=wasmExports.l,Module._free=wasmExports.m,Module._tama_wasm_load=wasmExports.n,Module._tama_wasm_set_value=wasmExports.o;function run(){if(runDependencies>0){dependenciesFulfilled=run;return}if(preRun(),runDependencies>0){dependenciesFulfilled=run;return}function e(){var r;Module.calledRun=!0,!ABORT&&(initRuntime(),readyPromiseResolve(Module),(r=Module.onRuntimeInitialized)==null||r.call(Module),postRun())}Module.setStatus?(Module.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>Module.setStatus(""),1),e()},1)):e()}if(Module.preInit)for(typeof Module.preInit=="function"&&(Module.preInit=[Module.preInit]);Module.preInit.length>0;)Module.preInit.pop()();return run(),moduleRtn=readyPromise,moduleRtn}})();let module;const initGame=async()=>{module=await TamaModule(),module!=null?(module._tama_wasm_init(),console.log("WASM module initialized"),await restoreFromDB()):console.error("Could not initialze WASM module")};function pumpMessages(){for(let e=0;e<25;e++)module!=null&&module._tama_wasm_step();setTimeout(pumpMessages)}function autoSave(){module!=null&&module._tama_wasm_save(),setTimeout(autoSave,5e3)}async function restoreFromDB(){if(module==null)return;const e=await readWasmStateFromIndexedDB();if(e==null)return;const r=module._malloc(e.length*4);if(r){for(let n=0;n<e.length;n++)module._tama_wasm_set_value(r,n,e[n]);module._tama_wasm_load(r),module._free(r),console.log("Restored from IndexedDB")}}self.saveToDB=function(e){saveWasmStateToIndexedDB(e).then(()=>{console.log("Saved to IndexedDB")}).catch(r=>{console.error("Error saving to IndexedDB: ",r)})},self.onmessage=function(e){if(e.data==="start")console.log("Starting event loop"),pumpMessages();else if(e.data==="save")module!=null&&module._tama_wasm_save();else if(typeof e.data!="string"){const{button:r,pressed:n}=e.data;console.log("Button: ",e.data),module!=null&&module._tama_wasm_button(r.charCodeAt(0),n?1:0)}},initGame().catch(e=>{console.error("Error initializing game: ",e)}),autoSave();var __viteBrowserExternal=Object.freeze({__proto__:null})})();
//# sourceMappingURL=worker-Bm1DpFd3.js.map
